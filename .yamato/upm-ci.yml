test_editors:
- version: trunk
test_platforms:
- name: win
  type: Unity::VM
  type_gpu: Unity::VM::GPU
  image: package-ci/win10:stable
  flavor: b1.large
all_test_projects:
  - path : TestProjects/GraphicsTestsHDRP
    name : HDRPTest
    gfx : true
  - path : TestProjects/GraphicsTestsURP
    name : URPTest
    gfx : true
  - path : TestProjects/ClusterSyncTests
    name : CoreSync
    gfx : false
---
{% for project in all_test_projects %}
pack_{{ project.name }}:
  name: Pack {{ project.name }}
  agent:
    type: Unity::VM
    image: package-ci/ubuntu:stable
    flavor: b1.large
  commands:
{% if project.gfx == "true" -%}
    - git submodule update --init
{% endif -%}
    - npm install upm-ci-utils@stable -g --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm 
    - upm-ci project pack --project-path {{ project.path }}
  artifacts:
    packages:
      paths:
      - "upm-ci~/packages/**/*"
  dependencies:
      - .yamato/upm-ci.yml#build_win
 {% endfor %}

build_win:
  name: Build native Quadro Sync
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - build.cmd
  artifacts:
    quadrosync_plugin:
      paths:
        - "source/com.unity.cluster-display/Runtime/Plugins/x86_64/**/*"

  {% for editor in test_editors %}
  {% for platform in test_platforms %}
  {% for project in all_test_projects %}
test_{{ platform.name }}_{{ editor.version }}_{{ project.name }}:
  name : Test {{ project.name }} {{ editor.version }} {{ platform.name }}
  agent:
    type: {% if project.gfx == "true" %}{{ platform.type_gpu }}{% else %}{{ platform.type }}{% endif %}
    image: {{ platform.image }}
    flavor: {{ platform.flavor}}
  commands:
{% if project.gfx == "true" -%}
  - git submodule update --init
{% endif -%}
  - npm install upm-ci-utils@stable -g --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm  
  - upm-ci project test --type project-tests --unity-version {{ editor.version }} --project-path  {{ project.path }}
  artifacts:
    logs.zip:
      paths:
      - "upm-ci~/test-results/**/*"
  dependencies:
  - .yamato/upm-ci.yml#pack_{{ project.name }}
  {% endfor %}
  {% endfor %}
  {% endfor %}

test_trigger:
  name: Run tests after package changes
  triggers:
    expression: pull_request.target eq "dev"
  dependencies:
    {% for editor in test_editors %}
    {% for platform in test_platforms %}
    {% for project in all_test_projects %}
  - .yamato/upm-ci.yml#test_{{platform.name}}_{{editor.version}}_{{ project.name }}
    {% endfor %}
    {% endfor %}
    {% endfor %}