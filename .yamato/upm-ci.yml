test_editors:
  - version: trunk

win_platform: &win
  name: win
  type: Unity::VM
  type_gpu: Unity::VM::GPU
  image: package-ci/win10:v4
  flavor: b1.large

ubuntu18_platform: &ubuntu18
  name: ubuntu18
  type: Unity::VM
  image: package-ci/ubuntu-18.04:v4
  flavor: b1.large

test_platforms:
  - *win

all_test_projects:
  - path : TestProjects/GraphicsTestsHDRP
    name : HDRPTest
    gfx : true
  - path : TestProjects/GraphicsTestsURP
    name : URPTest
    gfx : true
  - path : TestProjects/ClusterSyncTests
    name : CoreSync
    gfx : false
  - path : TestProjects/MissionControlTests
    name : MissionControlTests
    gfx : false
  - path : TestProjects/RPCTests
    name : RPCTests
    gfx : false
---

{% for project in all_test_projects -%}
pack_{{ project.name }}:
  name: Pack {{ project.name }}
  agent:
    type: {{ ubuntu18_platform.type }}
    image: {{ ubuntu18_platform.image }}
    flavor: {{ ubuntu18_platform.flavor }}
  commands:
{% if project.gfx == "true" -%}
    - git submodule update --init
{% endif -%}
    - npm install upm-ci-utils@stable -g --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm
    - upm-ci project pack --project-path {{ project.path }}
  artifacts:
    packages:
      paths:
      - "upm-ci~/packages/**/*"
{% if project.gfx == "false" -%}
  dependencies:
      - .yamato/upm-ci.yml#build_win
{% endif -%}
{% endfor %}

build_win:
  name: Build native Quadro Sync
  agent:
    type: {{ win_platform.type }}
    image: {{ win_platform.image }}
    flavor: {{ win_platform.flavor }}
  commands:
    - build.cmd
  artifacts:
    quadrosync_plugin:
      paths:
        - "source/com.unity.cluster-display/Runtime/Plugins/x86_64/**/*"

{% for editor in test_editors -%}
{% for platform in test_platforms -%}
{% for project in all_test_projects -%}
test_{{ platform.name }}_{{ editor.version }}_{{ project.name }}:
  name : Test {{ project.name }} {{ editor.version }} {{ platform.name }}
  agent:
    type: {% if project.gfx == "true" %}{{ platform.type_gpu }}{% else %}{{ platform.type }}{% endif %}
    image: {{ platform.image }}
    flavor: {{ platform.flavor}}
  commands:
{% if project.gfx == "true" -%}
  - git submodule update --init
{% endif -%}
  - npm install upm-ci-utils@stable -g --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm
  - upm-ci project test --type project-tests --unity-version {{ editor.version }} --project-path  {{ project.path }} --extra-editor-arg="--burst-disable-compilation"
  artifacts:
    logs.zip:
      paths:
      - "upm-ci~/test-results/**/*"
  dependencies:
  - .yamato/upm-ci.yml#pack_{{ project.name }}

{% endfor -%}
{% endfor -%}
{% endfor -%}

test_trigger_gfx:
  name: Run GFX tests after package changes
  triggers:
    expression: |
      pull_request.target eq "dev" AND
      (pull_request.push.changes.any match "source/com.unity.cluster-display.graphics/**" OR
      pull_request.push.changes.any match "TestProjects/GraphicsTests*/**")
  dependencies:
{% for editor in test_editors -%}
{% for platform in test_platforms -%}
{% for project in all_test_projects -%}
{% if project.gfx == "true" -%}
    - .yamato/upm-ci.yml#test_{{platform.name}}_{{editor.version}}_{{ project.name }}
{% endif -%}
{% endfor -%}
{% endfor -%}
{% endfor -%}
    - .yamato/Build_test/build_test.yml#Build_test_Cluster_Diplay_HDRP
    - .yamato/Build_test/build_test.yml#Build_test_Cluster_Diplay_URP
    
test_trigger:
  name: Run core tests after package changes
  triggers:
    expression: |
      pull_request.target eq "dev" AND NOT
      (pull_request.push.changes.all match "source/com.unity.cluster-display.graphics/**" OR
      pull_request.push.changes.all match "TestProjects/GraphicsTests*/**" OR
      pull_request.push.changes.all match "MissionControl-v2/**")
  dependencies:
{% for editor in test_editors -%}
{% for platform in test_platforms -%}
{% for project in all_test_projects -%}
{% if project.gfx == "false" -%}
    - .yamato/upm-ci.yml#test_{{platform.name}}_{{editor.version}}_{{ project.name }}
{% endif -%}
{% endfor -%}
{% endfor -%}
{% endfor -%}
    - .yamato/Build_test/build_test.yml#Build_test_Cluster_Diplay_HDRP
    - .yamato/Build_test/build_test.yml#Build_test_Cluster_Diplay_URP
nightly_trigger:
  name: Nightly tests trigger
  triggers:
    recurring:
      - branch: dev
        frequency: daily
        rerun: always
  dependencies:
    - .yamato/upm-ci.yml#test_trigger
    - .yamato/upm-ci.yml#test_trigger_gfx